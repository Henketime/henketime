<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Post</title>
  <script src="../components/blog-nav/blog-nav.js"></script>
  <script src="../components/post-reader/post-reader.js"></script>
  <script src="../components/markdown-reader/markdown-reader.js"></script>
  <script src="../components/bandcamp-embed-renderer/bandcamp-embed-renderer.js"></script>
  <link rel="stylesheet" href="../styles/styles.css">
  <!-- Markdown libraries -->
  <link rel="stylesheet" href="../../../lib/easymde.min.css">
  <script src="../../../lib/marked.min.js"></script>
</head>
<body>
  <blog-nav title="Post Reader">
    <button
      slot="left-button"
      id="leftButton"
      class="button button--nav"
      onclick="location.href='posts.html'"
    >
      All Posts
    </button>
    <button
      slot="right-button"
      id="rightButton"
      class="button button--nav"
      onclick="location.href='reader.html?file=2023-06-05-im-losing-myself.md'"
    >
      Read First Post
    </button>
  </blog-nav>
  <section>
    <h1>Post Reader</h1>
    <div class="button-row button-row--full-width">
      <button id="prevBtn" class="button">Previous</button>
      <button id="nextBtn" class="button">Next</button>
    </div>
    <post-reader id="postReader"></post-reader>
  </section>

  <script>
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    fetch('blogs-index.csv')
      .then(response => response.text())
      .then(text => {
        const lines = text.trim().split('\n').slice(1);
        if (lines.length < 2) {
          this.shadowRoot.querySelector('.posts-index').innerHTML = '<p>No posts available.</p>';
          return;
        }
        const posts = (
          lines
          .map(post => {
            const [title, filename, date] = post.split(',');
            return filename.trim();
          })
          .filter(Boolean)
          .filter(filename => filename.endsWith('.md'))
        );
        // Initialize the post reader with the specified file or the first post
        const file = getQueryParam('file');
        let currentIndex = posts.indexOf(file);
        if (file && currentIndex !== -1) {
          document.getElementById('postReader').setAttribute('src', `../posts/${file}`);
        } else {
          document.getElementById('postReader').setAttribute('markdown', 'No file specified.');
          currentIndex = 0;
        }

        function navigate(offset) {
          currentIndex = (currentIndex + offset + posts.length) % posts.length;
          window.location.search = '?file=' + encodeURIComponent(posts[currentIndex]);
        }
        document.getElementById('prevBtn').onclick = () => navigate(-1);
        document.getElementById('nextBtn').onclick = () => navigate(1);
      });
  </script>
  <script>
    document.getElementById('leftButton').addEventListener('click', () => {
      window.location.href = '../pages/create.html'
    });
    document.getElementById('rightButton').addEventListener('click', () => {
      window.location.href = '../pages/reader.html'
    });
  </script>
</body>
</html>